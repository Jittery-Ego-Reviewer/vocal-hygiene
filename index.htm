<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ë≠∑ËÅ≤Â∞èÂçöÂ£´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            touch-action: none;
            overflow: hidden;
            font-family: 'PingFang HK', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%);
            height: 100vh;
            width: 100vw;
            margin: 0;
        }

        .game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Ensure the content fits without pushing anything out */
            justify-content: space-between; 
            padding: 10px 0;
            box-sizing: border-box;
        }

        header {
            flex-shrink: 0;
            padding-bottom: 5px;
        }

        #tree-area {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            position: relative;
            min-height: 0; /* Important for flex child to shrink */
        }

        #tree {
            position: relative;
            /* Use smaller responsive size to guarantee space for baskets */
            width: 70vw; 
            max-width: 300px;
            aspect-ratio: 1 / 1;
            background: #2D5A27;
            border-radius: 50% 50% 45% 45%;
            box-shadow: inset -10px -10px 30px rgba(0,0,0,0.2);
            z-index: 1;
        }

        #tree::after {
            content: '';
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 35px;
            height: 40px;
            background: #5D4037;
            z-index: -1;
        }

        .apple {
            position: absolute;
            width: 54px;
            height: 54px;
            cursor: grab;
            user-select: none;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(0 3px 5px rgba(0,0,0,0.1));
            transition: transform 0.2s ease;
        }

        .apple-body {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #FF4444;
            border-radius: 50% 50% 45% 45%;
            box-shadow: inset -3px -3px 6px rgba(0,0,0,0.2);
        }

        .apple-leaf {
            position: absolute;
            top: -3px;
            left: 50%;
            width: 10px;
            height: 14px;
            background: #4CAF50;
            border-radius: 0 100% 0 100%;
            transform: translateX(-50%) rotate(-15deg);
        }

        .apple-text {
            position: relative;
            z-index: 11;
            color: white;
            font-weight: bold;
            font-size: 10px;
            text-align: center;
            padding: 3px;
            line-height: 1.1;
            pointer-events: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .apple.revealed .apple-text {
            opacity: 1;
        }

        .basket-container {
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 10px 5px;
            flex-shrink: 0; /* Prevent baskets from shrinking/disappearing */
            z-index: 5;
            background: rgba(255,255,255,0.1); /* Subtle floor area */
        }

        .basket {
            width: 45vw;
            max-width: 140px;
            height: 75px; /* Shorter baskets */
            border-radius: 8px 8px 40% 40%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: 2px solid rgba(255,255,255,0.3);
        }

        #good-basket { background: #43A047; }
        #bad-basket { background: #E53935; }

        .dragging {
            z-index: 100;
            cursor: grabbing;
            transform: scale(1.3);
        }

        .success-msg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            text-align: center;
            display: none;
            z-index: 1000;
            width: 85%;
        }

        .confetti {
            position: fixed;
            width: 8px;
            height: 8px;
            z-index: 999;
        }
    </style>
</head>
<body>

<div class="game-container">
    <header class="text-center">
        <h1 class="text-xl font-bold text-green-800">üçé Ë≠∑ËÅ≤Â∞èÂçöÂ£´</h1>
        <p class="text-[12px] text-blue-700">ÈªûÊìäËòãÊûúÁúãÁøíÊÖ£ÔºåÁÑ∂ÂæåÊãñÂà∞Á±ÉÂ≠êÔºÅ</p>
    </header>

    <div id="tree-area">
        <div id="tree">
            <!-- Apples will be generated here -->
        </div>
    </div>

    <div class="basket-container">
        <div id="good-basket" class="basket">
            <span class="text-base">Â•ΩÁøíÊÖ£</span>
        </div>

        <div id="bad-basket" class="basket">
            <span class="text-base">Â£ûÁøíÊÖ£</span>
        </div>
    </div>

    <div id="success-modal" class="success-msg">
        <h2 class="text-2xl font-bold mb-3 text-green-600">üåü Â§™Ê£í‰∫ÜÔºÅ</h2>
        <p class="text-base mb-5">‰Ω†Â≠∏ÊúÉ‰∫ÜÂ¶Ç‰Ωï‰øùË≠∑ËÅ≤Èü≥ÔºÅ</p>
        <button onclick="location.reload()" class="bg-blue-500 text-white px-6 py-2 rounded-full font-bold text-lg hover:bg-blue-600 shadow-lg">ÂÜçÁé©‰∏ÄÊ¨°</button>
    </div>
</div>

<script>
    const habits = [
        { text: "ÊÖ¢ÊÖ¢Ë™¨Ë©±", good: true },
        { text: "Â§öÂñùÊ∞¥", good: true },
        { text: "ËºïËÅ≤Ë™¨Ë©±", good: true },
        { text: "Áù°Ë¶∫‰ºëÊÅØ", good: true },
        { text: "Áî®ÈºªÂ≠êÂëºÂê∏", good: true },
        { text: "Â∞ñÂè´", good: false },
        { text: "Â§ßÂè´", good: false },
        { text: "‰∏çÂñùÊ∞¥", good: false },
        { text: "‰∏çÂÅúË™¨Ë©±", good: false },
        { text: "Â§ßÂì≠", good: false },
        { text: "Áî®Âè£ÂëºÂê∏", good: false },
        { text: "Á∂ìÂ∏∏ÂêÉÁÖéÁÇ∏È£üÁâ©", good: false },
        { text: "Á∂ìÂ∏∏ÂêÉËæõËæ£È£üÁâ©", good: false }
    ];

    const tree = document.getElementById('tree');
    const goodBasket = document.getElementById('good-basket');
    const badBasket = document.getElementById('bad-basket');
    let applesRemaining = habits.length;

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playCorrectSound() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.3);
    }

    function initApples() {
        const rect = tree.getBoundingClientRect();
        const treeWidth = rect.width;
        const treeHeight = rect.height;
        const shuffledHabits = [...habits].sort(() => Math.random() - 0.5);

        const cols = 3;
        const colWidth = treeWidth / (cols + 1);
        const rowHeight = treeHeight / 5.5; 

        shuffledHabits.forEach((habit, index) => {
            const apple = document.createElement('div');
            apple.className = 'apple';
            apple.dataset.good = habit.good;
            
            const col = index % cols;
            const row = Math.floor(index / cols);
            const isLastApple = index === shuffledHabits.length - 1;
            
            let x, y;
            if (isLastApple) {
                x = (treeWidth / 2) - 27;
                y = (row + 1) * rowHeight - 27;
            } else {
                x = (col + 1) * colWidth - 27; 
                y = (row + 1) * rowHeight - 27;
            }

            const wiggle = 4;
            x += (Math.random() - 0.5) * wiggle;
            y += (Math.random() - 0.5) * wiggle;
            
            apple.style.left = `${x}px`;
            apple.style.top = `${y}px`;
            apple.dataset.origX = x;
            apple.dataset.origY = y;
            
            apple.innerHTML = `
                <div class="apple-body"></div>
                <div class="apple-leaf"></div>
                <div class="apple-text">${habit.text}</div>
            `;
            
            setupDraggable(apple);
            tree.appendChild(apple);
        });
    }

    function setupDraggable(el) {
        let startX, startY, initialLeft, initialTop;
        let isDragging = false;
        let revealTimeout = null;

        const onStart = (e) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            el.classList.add('revealed');
            if (revealTimeout) clearTimeout(revealTimeout);
            
            revealTimeout = setTimeout(() => {
                el.classList.remove('revealed');
            }, 1000);

            isDragging = true;
            el.classList.add('dragging');

            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            const rect = el.getBoundingClientRect();
            startX = clientX;
            startY = clientY;
            initialLeft = rect.left;
            initialTop = rect.top;

            el.style.position = 'fixed';
            el.style.left = `${initialLeft}px`;
            el.style.top = `${initialTop}px`;
            el.style.width = '54px'; 
            el.style.height = '54px';
            document.body.appendChild(el);
        };

        const onMove = (e) => {
            if (!isDragging) return;
            if (e.cancelable) e.preventDefault();
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            const dx = clientX - startX;
            const dy = clientY - startY;
            
            el.style.left = `${initialLeft + dx}px`;
            el.style.top = `${initialTop + dy}px`;
        };

        const onEnd = (e) => {
            if (!isDragging) return;
            isDragging = false;
            el.classList.remove('dragging');
            
            const rect = el.getBoundingClientRect();
            const appleCenterX = rect.left + rect.width / 2;
            const appleCenterY = rect.top + rect.height / 2;
            
            const goodRect = goodBasket.getBoundingClientRect();
            const badRect = badBasket.getBoundingClientRect();
            const isGood = el.dataset.good === "true";

            if (isPointInRect(appleCenterX, appleCenterY, goodRect)) {
                if (isGood) handleSuccess(el);
                else returnToOriginalPos(el);
            } 
            else if (isPointInRect(appleCenterX, appleCenterY, badRect)) {
                if (!isGood) handleSuccess(el);
                else returnToOriginalPos(el);
            } else {
                returnToOriginalPos(el);
            }
        };

        el.addEventListener('mousedown', onStart);
        el.addEventListener('touchstart', onStart, { passive: false });
        window.addEventListener('mousemove', onMove);
        window.addEventListener('touchmove', onMove, { passive: false });
        window.addEventListener('mouseup', onEnd);
        window.addEventListener('touchend', onEnd);
    }

    function handleSuccess(el) {
        playCorrectSound();
        el.style.transition = "transform 0.4s ease-in, opacity 0.4s";
        el.style.transform = "scale(0) rotate(20deg)";
        el.style.opacity = "0";
        setTimeout(() => {
            el.remove();
            applesRemaining--;
            if (applesRemaining === 0) showSuccess();
        }, 400);
    }

    function returnToOriginalPos(el) {
        el.style.transition = "all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)";
        const treeRect = tree.getBoundingClientRect();
        const targetX = treeRect.left + parseFloat(el.dataset.origX);
        const targetY = treeRect.top + parseFloat(el.dataset.origY);
        
        el.style.left = `${targetX}px`;
        el.style.top = `${targetY}px`;
        
        setTimeout(() => {
            el.style.transition = "";
            el.classList.remove('revealed');
            el.style.position = 'absolute';
            el.style.left = `${el.dataset.origX}px`;
            el.style.top = `${el.dataset.origY}px`;
            tree.appendChild(el);
        }, 500);
    }

    function isPointInRect(x, y, rect) {
        return x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
    }

    function showSuccess() {
        document.getElementById('success-modal').style.display = 'block';
        createConfetti();
    }

    function createConfetti() {
        for (let i = 0; i < 40; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.top = '-10px';
            confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 75%, 60%)`;
            document.body.appendChild(confetti);

            confetti.animate([
                { transform: `translate3d(0,0,0) rotate(0)`, opacity: 1 },
                { transform: `translate3d(${(Math.random() - 0.5) * 200}px, 100vh, 0) rotate(${Math.random() * 1000}deg)`, opacity: 0 }
            ], {
                duration: 2000 + Math.random() * 1500,
                easing: 'ease-out'
            }).onfinish = () => confetti.remove();
        }
    }

    window.addEventListener('load', initApples);
</script>

</body>
</html>
